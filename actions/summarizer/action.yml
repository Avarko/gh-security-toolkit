name: "Summarizer"
description: "Runs JBang-based summarizer for Trivy and Semgrep results and returns a combined Markdown body."
inputs:
  fs_json:
    description: "Filesystem scan JSON"
    required: false
    default: ""
  image_json:
    description: "Image scan JSON"
    required: false
    default: ""
  semgrep_summary:
    description: "Semgrep summary markdown file"
    required: false
    default: ""
  outdir:
    description: "Output directory"
    required: true
  title_vuln_fs:
    description: "Title for FS vulnerabilities section"
    required: false
    default: "Trivy (fs) vulnerability summary"
  title_mis_fs:
    description: "Title for FS misconfiguration section"
    required: false
    default: "Trivy (fs) misconfiguration summary"
  title_vuln_img:
    description: "Title for Image vulnerabilities section"
    required: false
    default: "Trivy (image) vulnerability summary"
  title_mis_img:
    description: "Title for Image misconfiguration section"
    required: false
    default: "Trivy (image) misconfiguration summary"
  title_semgrep:
    description: "Title for Semgrep SAST section"
    required: false
    default: "Semgrep SAST summary"
  max_rows:
    description: "Max rows in summaries"
    required: false
    default: "50"
runs:
  using: "composite"
  steps:
    - name: Setup JBang
      uses: jbangdev/setup-jbang@main

    - name: Summarize FS (if provided)
      if: ${{ inputs.fs_json != '' }}
      shell: bash
      env:
        TITLE_VULN: ${{ inputs.title_vuln_fs }}
        TITLE_MIS:  ${{ inputs.title_mis_fs }}
      run: |
        jbang "${{ github.action_path }}/../../scripts/trivy_summarize.java" \
          "${{ inputs.fs_json }}" "${{ inputs.max_rows }}" "${{ inputs.outdir }}"
        # Rename to temp file to avoid overwrite (if file was created)
        [ -f "${{ inputs.outdir }}/TRIVY_SUMMARY.md" ] && \
          mv "${{ inputs.outdir }}/TRIVY_SUMMARY.md" "${{ inputs.outdir }}/TRIVY_SUMMARY_FS.md" || \
          echo "No TRIVY_SUMMARY.md created for FS scan"

    - name: Summarize Image (if provided)
      if: ${{ inputs.image_json != '' }}
      shell: bash
      env:
        TITLE_VULN: ${{ inputs.title_vuln_img }}
        TITLE_MIS:  ${{ inputs.title_mis_img }}
      run: |
        jbang "${{ github.action_path }}/../../scripts/trivy_summarize.java" \
          "${{ inputs.image_json }}" "${{ inputs.max_rows }}" "${{ inputs.outdir }}"
        # Rename to temp file (if file was created)
        [ -f "${{ inputs.outdir }}/TRIVY_SUMMARY.md" ] && \
          mv "${{ inputs.outdir }}/TRIVY_SUMMARY.md" "${{ inputs.outdir }}/TRIVY_SUMMARY_IMAGE.md" || \
          echo "No TRIVY_SUMMARY.md created for Image scan"

    - name: Combine Trivy summaries
      shell: bash
      run: |
        summary="${{ inputs.outdir }}/TRIVY_SUMMARY.md"
        > "$summary"  # Create empty file

        # Append FS summary if exists
        if [ -f "${{ inputs.outdir }}/TRIVY_SUMMARY_FS.md" ]; then
          cat "${{ inputs.outdir }}/TRIVY_SUMMARY_FS.md" >> "$summary"
          echo "" >> "$summary"
        fi

        # Append Image summary if exists
        if [ -f "${{ inputs.outdir }}/TRIVY_SUMMARY_IMAGE.md" ]; then
          cat "${{ inputs.outdir }}/TRIVY_SUMMARY_IMAGE.md" >> "$summary"
          echo "" >> "$summary"
        fi

    - name: Combine summaries to release body
      id: combine
      shell: bash
      run: |
        out="${{ inputs.outdir }}/RELEASE_BODY.md"
        echo "## ðŸ” Security Scan Summary" > "$out"
        echo "" >> "$out"

        # Add diff if exists
        if [ -f "${{ inputs.outdir }}/diff.md" ]; then
          cat "${{ inputs.outdir }}/diff.md" >> "$out"
          echo "" >> "$out"
        fi

        # Add Trivy summary if exists
        if [ -f "${{ inputs.outdir }}/TRIVY_SUMMARY.md" ]; then
          cat "${{ inputs.outdir }}/TRIVY_SUMMARY.md" >> "$out"
          echo "" >> "$out"
        fi

        # Add Semgrep summary if exists
        if [ -f "${{ inputs.outdir }}/SEMGREP_SUMMARY.md" ]; then
          cat "${{ inputs.outdir }}/SEMGREP_SUMMARY.md" >> "$out"
          echo "" >> "$out"
        fi

        echo "release_body=$out" >> "$GITHUB_OUTPUT"
outputs:
  release_body_markdown:
    description: "Path to combined release body"
    value: ${{ steps.combine.outputs.release_body }}
