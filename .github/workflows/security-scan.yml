name: Security Scan

on:
  workflow_call:
    inputs:
      filesystem_artifact:
        description: 'Artifact containing filesystem to scan. Use actions/uploader/filesystem to upload, or leave default to use the standard artifact name.'
        type: string
        required: false
        default: '__gh_security_toolkit__filesystem__'

      docker_image_artifact:
        description: 'Artifact containing Docker image tar file. Use actions/uploader/docker-image to upload, or leave default to use the standard artifact name.'
        type: string
        required: false
        default: '__gh_security_toolkit__docker_image__'

      # === TRIVY CONFIGURATION ===
      trivy_config:
        description: 'Path to .trivy.yaml config file (relative to filesystem_artifact root)'
        type: string
        required: false
        default: ''

      trivy_severity:
        description: 'Minimum severity to report (UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL)'
        type: string
        required: false
        default: 'MEDIUM,HIGH,CRITICAL'

      # === RESULT RETENTION ===
      retention_days:
        description: 'Days to retain scan results'
        type: number
        required: false
        default: 30

      retention_keep:
        description: 'Results per channel to retain scan results'
        type: number
        required: false
        default: 10

      # === METADATA FOR REPORTING ===
      channel:
        description: 'Channel name for release grouping (tag-friendly, e.g., "master", "dev", "prod"). Used in tags and release retention.'
        type: string
        required: true

      branch:
        description: 'Git branch name (for reports/notifications, can contain slashes)'
        type: string
        required: false
        default: ''

      repository:
        description: 'Repository name (owner/repo, for reports)'
        type: string
        required: false
        default: ''

      commit_sha:
        description: 'Git commit SHA (for reports)'
        type: string
        required: false
        default: ''

      image_name:
        description: 'Docker image name (for reports)'
        type: string
        required: false
        default: ''

      dependabot_gh_token:
        description: 'GitHub Personal Access Token (PAT) with security_events scope for Dependabot API. Optional - if not provided, Dependabot scan is skipped.'
        type: string
        required: false
        default: ''

    secrets:
      SLACK_BOT_TOKEN:
        description: 'Slack OAuth token (xoxb-...) for notifications'
        required: false

permissions:
  contents: write
  actions: write
  security-events: write

jobs:
  security-scan:
    runs-on: ubuntu-latest
    # Note: All action references use @improvements for testing.
    # When merging to main, update all @improvements refs to @main or use version tags like @v1.0.0
    steps:
      - name: Setup directories
        id: setup
        run: |
          OUTPUT_DIR="${RUNNER_TEMP}/scan-output-${{ github.run_id }}"
          WORK_DIR="${RUNNER_TEMP}/scan-workspace-${{ github.run_id }}"
          mkdir -p "$OUTPUT_DIR" "$WORK_DIR"
          echo "output_dir=$OUTPUT_DIR" >> "$GITHUB_OUTPUT"
          echo "work_dir=$WORK_DIR" >> "$GITHUB_OUTPUT"

      - name: Timestamp
        id: ts
        run: echo "ts=$(date -u +%Y-%m-%d-%H%M%SZ)" >> "$GITHUB_OUTPUT"

      - name: Validate channel name
        run: |
          CHANNEL="${{ inputs.channel }}"

          # Check if empty
          if [ -z "$CHANNEL" ]; then
            echo "❌ Error: channel is required but empty"
            exit 1
          fi

          # Check length (max 35 characters)
          if [ ${#CHANNEL} -gt 35 ]; then
            echo "❌ Error: channel name too long (max 35 characters): '$CHANNEL'"
            exit 1
          fi

          # Check for invalid characters (only allow: a-z, A-Z, 0-9, dash, underscore)
          if ! echo "$CHANNEL" | grep -qE '^[a-zA-Z0-9_-]+$'; then
            echo "❌ Error: channel contains invalid characters: '$CHANNEL'"
            echo "   Allowed: a-z, A-Z, 0-9, dash (-), underscore (_)"
            exit 1
          fi

          # Check it doesn't start/end with dash or underscore
          if echo "$CHANNEL" | grep -qE '^[-_]|[-_]$'; then
            echo "❌ Error: channel cannot start or end with dash/underscore: '$CHANNEL'"
            exit 1
          fi

          echo "✅ Channel name is valid: '$CHANNEL'"

      # === DOWNLOAD ARTIFACTS ===
      - name: Download filesystem artifact
        id: download_fs
        continue-on-error: true
        uses: actions/download-artifact@v6
        with:
          name: ${{ inputs.filesystem_artifact }}
          path: ${{ steps.setup.outputs.work_dir }}/filesystem

      - name: Download docker image artifact
        id: download_image
        continue-on-error: true
        uses: actions/download-artifact@v6
        with:
          name: ${{ inputs.docker_image_artifact }}
          path: ${{ steps.setup.outputs.work_dir }}/image

      - name: Find Docker image tar
        if: ${{ steps.download_image.outcome == 'success' }}
        id: find_tar
        run: |
          TAR_FILE=$(find "${{ steps.setup.outputs.work_dir }}/image" -name "*.tar" -type f | head -n1)
          echo "tar_path=$TAR_FILE" >> "$GITHUB_OUTPUT"

      # === RUN TRIVY SCANS ===
      - name: Run Trivy scans
        id: scan
        uses: Avarko/gh-security-toolkit/actions/scanner/trivy@improvements
        with:
          filesystem_path: ${{ steps.download_fs.outcome == 'success' && format('{0}/filesystem', steps.setup.outputs.work_dir) || '' }}
          docker_image_tar: ${{ steps.download_image.outcome == 'success' && steps.find_tar.outputs.tar_path || '' }}
          trivy_config: ${{ inputs.trivy_config != '' && format('{0}/filesystem/{1}', steps.setup.outputs.work_dir, inputs.trivy_config) || '' }}
          trivy_severity: ${{ inputs.trivy_severity }}
          trivy_output_dir: ${{ steps.setup.outputs.output_dir }}

      # === RUN SEMGREP SCAN ===
      - name: Run Semgrep scan
        id: semgrep
        if: ${{ steps.download_fs.outcome == 'success' }}
        uses: Avarko/gh-security-toolkit/actions/scanner/semgrep@improvements
        with:
          filesystem_path: ${{ format('{0}/filesystem', steps.setup.outputs.work_dir) }}
          semgrep_output_dir: ${{ steps.setup.outputs.output_dir }}
          semgrep_configs: "p/owasp-top-ten,p/java,p/javascript,p/dockerfile,p/terraform,p/secrets"

      # === FETCH DEPENDABOT ALERTS ===
      - name: Fetch Dependabot alerts
        id: dependabot
        if: ${{ inputs.dependabot_gh_token != '' }}
        uses: Avarko/gh-security-toolkit/actions/scanner/dependabot@improvements
        with:
          repository: ${{ inputs.repository }}
          github_token: ${{ inputs.dependabot_gh_token }}
          dependabot_output_dir: ${{ steps.setup.outputs.output_dir }}

      # === DIFF WITH PREVIOUS RELEASE ===
      - name: Diff with previous release
        id: diff
        uses: Avarko/gh-security-toolkit/actions/diff/github-release@improvements
        with:
          current_fs: ${{ steps.scan.outputs.fs_json }}
          current_image: ${{ steps.scan.outputs.image_json }}
          channel: security-scan-${{ inputs.channel }}
          outdir: ${{ steps.setup.outputs.output_dir }}

      - name: Summarizer
        id: sum
        uses: Avarko/gh-security-toolkit/actions/summarizer@improvements
        with:
          fs_json: ${{ steps.scan.outputs.fs_json || '' }}
          image_json: ${{ steps.scan.outputs.image_json || '' }}
          semgrep_summary: ${{ steps.semgrep.outputs.semgrep_summary || '' }}
          dependabot_summary: ${{ steps.dependabot.outputs.dependabot_summary || '' }}
          outdir: ${{ steps.setup.outputs.output_dir }}
          title_vuln_fs: "Trivy (filesystem) vulnerability summary"
          title_mis_fs: "Trivy (filesystem) misconfiguration summary"
          title_vuln_img: "Trivy (image) vulnerability summary"
          title_mis_img: "Trivy (image) misconfiguration summary"

      # === PUBLISH TO GITHUB RELEASE ===
      - name: Publish scan results
        uses: Avarko/gh-security-toolkit/actions/publisher/github-release@improvements
        with:
          outdir: ${{ steps.setup.outputs.output_dir }}
          metadata_timestamp: ${{ steps.ts.outputs.ts }}
          metadata_branch: ${{ inputs.branch }}
          metadata_repository: ${{ inputs.repository }}
          metadata_commit_sha: ${{ inputs.commit_sha }}
          metadata_image_name: ${{ inputs.image_name }}
          metadata_scan_id: ${{ github.run_id }}
          release_name: "Security Scan ${{ inputs.channel }} ${{ steps.ts.outputs.ts }}"
          tag_name: "security-scan-${{ inputs.channel }}-${{ steps.ts.outputs.ts }}"
          body_file: ${{ steps.sum.outputs.release_body_markdown }}
          draft: "false"
          prerelease: "true"
          overwrite_tag: "false"
          channel: "security-scan-${{ inputs.channel }}"
          retention_keep: "${{ inputs.retention_keep }}"
          retention_days: "${{ inputs.retention_days }}"
          github_token: ${{ secrets.GH_TOKEN || github.token }}