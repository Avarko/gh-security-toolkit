name: Security Scan

on:
  workflow_call:
    inputs:
      filesystem_artifact:
        description: 'Artifact containing filesystem to scan (source, configs, dependencies)'
        type: string
        required: false

      docker_image_artifact:
        description: 'Artifact containing Docker image tar file'
        type: string
        required: false

      # === TRIVY CONFIGURATION ===
      trivy_config:
        description: 'Path to .trivy.yaml config file (relative to filesystem_artifact root)'
        type: string
        required: false
        default: ''

      trivy_severity:
        description: 'Minimum severity to report (UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL)'
        type: string
        required: false
        default: 'MEDIUM,HIGH,CRITICAL'

      # === RESULT RETENTION ===
      retention_days:
        description: 'Days to retain scan results as artifacts'
        type: number
        required: false
        default: 30

      # === METADATA FOR REPORTING ===
      branch:
        description: 'Git branch name (for reports/notifications)'
        type: string
        required: false
        default: ''

      repository:
        description: 'Repository name (owner/repo, for reports)'
        type: string
        required: false
        default: ''

      commit_sha:
        description: 'Git commit SHA (for reports)'
        type: string
        required: false
        default: ''

      image_name:
        description: 'Docker image name (for reports)'
        type: string
        required: false
        default: ''

    secrets:
      SLACK_BOT_TOKEN:
        description: 'Slack OAuth token (xoxb-...) for notifications'
        required: false

      GH_TOKEN:
        description: 'GitHub token for API access'
        required: true

permissions:
  contents: read
  actions: write
  security-events: write

jobs:
  security-scan:
    runs-on: ubuntu-latest
    # Note: All action references use @improvements for testing.
    # When merging to main, update all @improvements refs to @main or use version tags like @v1.0.0
    steps:
      - name: Setup directories
        id: setup
        run: |
          OUTPUT_DIR="${RUNNER_TEMP}/scan-output-${{ github.run_id }}"
          WORK_DIR="${RUNNER_TEMP}/scan-workspace-${{ github.run_id }}"
          mkdir -p "$OUTPUT_DIR" "$WORK_DIR"
          echo "output_dir=$OUTPUT_DIR" >> "$GITHUB_OUTPUT"
          echo "work_dir=$WORK_DIR" >> "$GITHUB_OUTPUT"

      - name: Timestamp
        id: ts
        run: echo "ts=$(date -u +%Y-%m-%d-%H%M%S)" >> "$GITHUB_OUTPUT"

      # === DOWNLOAD ARTIFACTS ===
      - name: Download filesystem artifact
        if: ${{ inputs.filesystem_artifact != '' }}
        uses: actions/download-artifact@v6
        with:
          name: ${{ inputs.filesystem_artifact }}
          path: ${{ steps.setup.outputs.work_dir }}/filesystem

      - name: Download docker image artifact
        if: ${{ inputs.docker_image_artifact != '' }}
        uses: actions/download-artifact@v6
        with:
          name: ${{ inputs.docker_image_artifact }}
          path: ${{ steps.setup.outputs.work_dir }}/image

      - name: Find Docker image tar
        if: ${{ inputs.docker_image_artifact != '' }}
        id: find_tar
        run: |
          TAR_FILE=$(find "${{ steps.setup.outputs.work_dir }}/image" -name "*.tar" -type f | head -n1)
          echo "tar_path=$TAR_FILE" >> "$GITHUB_OUTPUT"

      # === RUN TRIVY SCANS ===
      - name: Run Trivy scans
        id: scan
        uses: Avarko/gh-security-toolkit/actions/scanner/trivy@improvements
        with:
          filesystem_path: ${{ inputs.filesystem_artifact != '' && format('{0}/filesystem', steps.setup.outputs.work_dir) || '' }}
          docker_image_tar: ${{ inputs.docker_image_artifact != '' && steps.find_tar.outputs.tar_path || '' }}
          trivy_config: ${{ inputs.trivy_config != '' && format('{0}/filesystem/{1}', steps.setup.outputs.work_dir, inputs.trivy_config) || '' }}
          trivy_severity: ${{ inputs.trivy_severity }}
          trivy_output_dir: ${{ steps.setup.outputs.output_dir }}
          timestamp: ${{ steps.ts.outputs.ts }}

      # === DIFF WITH PREVIOUS RELEASE ===
      - name: Diff with previous release
        id: diff
        uses: Avarko/gh-security-toolkit/actions/diff/github-release@improvements
        with:
          current_fs: ${{ steps.scan.outputs.fs_json }}
          current_image: ${{ steps.scan.outputs.image_json }}
          channel: security-scan-${{ inputs.branch }}
          outdir: ${{ steps.setup.outputs.output_dir }}

      - name: Summarizer
        id: sum
        uses: Avarko/gh-security-toolkit/actions/summarizer@improvements
        with:
          fs_json: ${{ steps.scan.outputs.fs_json || '' }}
          image_json: ${{ steps.scan.outputs.image_json || '' }}
          outdir: ${{ steps.setup.outputs.output_dir }}
          title_vuln_fs: "Trivy (filesystem) vulnerability summary"
          title_mis_fs: "Trivy (filesystem) misconfiguration summary"
          title_vuln_img: "Trivy (image) vulnerability summary"
          title_mis_img: "Trivy (image) misconfiguration summary"

      # === PUBLISH TO GITHUB RELEASE ===
      - name: Publish scan results
        uses: Avarko/gh-security-toolkit/actions/publisher/github-release@improvements
        with:
          outdir: ${{ steps.setup.outputs.output_dir }}
          metadata_timestamp: ${{ steps.ts.outputs.ts }}
          metadata_branch: ${{ inputs.branch }}
          metadata_repository: ${{ inputs.repository }}
          metadata_commit_sha: ${{ inputs.commit_sha }}
          metadata_image_name: ${{ inputs.image_name }}
          metadata_scan_id: ${{ github.run_id }}
          release_name: "Security Scan ${{ inputs.branch }} ${{ steps.ts.outputs.ts }}"
          tag_name: "security-scan-${{ steps.ts.outputs.ts }}"
          body_file: ${{ steps.sum.outputs.release_body_markdown }}
          draft: "false"
          prerelease: "true"
          overwrite_tag: "false"
          channel: "security-scan-${{ inputs.branch }}"
          retention_keep: "10"
          retention_days: "${{ inputs.retention_days }}"
          github_token: ${{ secrets.GH_TOKEN }}